# Netlify configuration for Urban Hub website (urbanhub.uk)
# Deploy with base directory: website (or run from website folder)
# Redirect order: first match wins. Put 301s first, SPA fallback last.

[build]
  command = "npm run build"
  publish = "dist"
  environment = { NODE_VERSION = "18" }

# ========== 301 redirects (old urbanhub.uk URLs → new structure) ==========
# Terms
[[redirects]]
  from = "/terms-condition"
  to = "/terms"
  status = 301
  force = true
[[redirects]]
  from = "/terms-condition/"
  to = "/terms"
  status = 301
  force = true

# Blog, Reviews, Contact, FAQ, About, Privacy, Terms: do NOT redirect trailing slash
# here—Netlify or CDN may add trailing slash to /about etc., causing /about/ -> /about
# 301 to loop with "add slash" rule. Both /about and /about/ now serve SPA; client normalizes.

# Academic year booking → portal
[[redirects]]
  from = "/academic-year-booking"
  to = "https://portal.urbanhub.uk/studios/2025-2026"
  status = 301
  force = true
[[redirects]]
  from = "/academic-year-booking/"
  to = "https://portal.urbanhub.uk/studios/2025-2026"
  status = 301
  force = true
[[redirects]]
  from = "/academic-year-booking-26-27"
  to = "https://portal.urbanhub.uk/studios/2026-2027"
  status = 301
  force = true
[[redirects]]
  from = "/academic-year-booking-26-27/"
  to = "https://portal.urbanhub.uk/studios/2026-2027"
  status = 301
  force = true

# Short term
[[redirects]]
  from = "/short-term-stays"
  to = "/short-term"
  status = 301
  force = true
[[redirects]]
  from = "/short-term-stays/"
  to = "/short-term"
  status = 301
  force = true
[[redirects]]
  from = "/urban-hub-keyworkers"
  to = "/short-term?tab=keyworker"
  status = 301
  force = true
[[redirects]]
  from = "/urban-hub-keyworkers/"
  to = "/short-term?tab=keyworker"
  status = 301
  force = true

# Studio 26-27 grade pages (old /studio-2627/* → portal, format: /studios/2026-2027/{slug})
[[redirects]]
  from = "/studio-2627/gold-studios"
  to = "https://portal.urbanhub.uk/studios/2026-2027/gold"
  status = 301
  force = true
[[redirects]]
  from = "/studio-2627/gold-studios/"
  to = "https://portal.urbanhub.uk/studios/2026-2027/gold"
  status = 301
  force = true
[[redirects]]
  from = "/studio-2627/silver-studios"
  to = "https://portal.urbanhub.uk/studios/2026-2027/silver"
  status = 301
  force = true
[[redirects]]
  from = "/studio-2627/silver-studios/"
  to = "https://portal.urbanhub.uk/studios/2026-2027/silver"
  status = 301
  force = true
[[redirects]]
  from = "/studio-2627/platinum-studios"
  to = "https://portal.urbanhub.uk/studios/2026-2027/platinum"
  status = 301
  force = true
[[redirects]]
  from = "/studio-2627/platinum-studios/"
  to = "https://portal.urbanhub.uk/studios/2026-2027/platinum"
  status = 301
  force = true
[[redirects]]
  from = "/studio-2627/rhodium-plus-studios"
  to = "https://portal.urbanhub.uk/studios/2026-2027/rhodium-plus"
  status = 301
  force = true
[[redirects]]
  from = "/studio-2627/rhodium-plus-studios/"
  to = "https://portal.urbanhub.uk/studios/2026-2027/rhodium-plus"
  status = 301
  force = true
[[redirects]]
  from = "/studio-2627/rhodiun-studios"
  to = "https://portal.urbanhub.uk/studios/2026-2027/rhodium"
  status = 301
  force = true
[[redirects]]
  from = "/studio-2627/rhodiun-studios/"
  to = "https://portal.urbanhub.uk/studios/2026-2027/rhodium"
  status = 301
  force = true

# Blog sitemap (dynamic: generated from Supabase on each request; updates when posts are added)
[[redirects]]
  from = "/sitemap-blog.xml"
  to = "/.netlify/functions/sitemap-blog"
  status = 200
  force = true

# SPA fallback – must be last. Do NOT use force = true, or /assets/*.js and *.css
# get index.html (wrong MIME) and break. Without force, Netlify serves real files first.
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

# ========== Headers ==========
# CSP: Allow fonts (Google), styles (Stripe iframe loads fonts.googleapis.com), Stripe frames and connect.
# If you set CSP in Netlify UI, remove font-src 'none' / restrictive style-src or this may conflict.
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-XSS-Protection = "1; mode=block"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Content-Security-Policy = "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com https://www.googletagmanager.com https://www.google-analytics.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://m.stripe.network; font-src 'self' https://fonts.gstatic.com https://fonts.googleapis.com data:; frame-src 'self' https://js.stripe.com https://hooks.stripe.com https://m.stripe.network https://www.googletagmanager.com; connect-src 'self' https://*.supabase.co https://api.stripe.com https://*.stripe.com wss://*.stripe.com https://www.google-analytics.com https://region1.google-analytics.com https://analytics.google.com https://region1.analytics.google.com https://stats.g.doubleclick.net https://www.googletagmanager.com https://www.google.com; img-src 'self' data: https: blob:; object-src 'none'; base-uri 'self'"

# SPA index - short cache so deploys get fresh HTML and chunk references
[[headers]]
  for = "/index.html"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"

# Hashed JS/CSS - long cache (Vite uses content hashes; immutable = no revalidation)
[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
